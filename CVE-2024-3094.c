#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Define vulnerable versions and other constants
const char* VULNERABLE_VERSIONS[] = {"5.6.0", "5.6.1"};
const char* STABLE_VERSION = "5.4.6";
const char* STABLE_VERSION_URL = "https://excellmedia.dl.sourceforge.net/project/lzmautils/xz-5.4.6.tar.bz2";

// Detect OS and package manager
void detect_os_and_package_manager(char* package_manager, char* version_command) {
    FILE* os_release = fopen("/etc/os-release", "r");
    if (os_release != NULL) {
        char line[100];
        while (fgets(line, sizeof(line), os_release)) {
            if (strstr(line, "debian_version") != NULL || strstr(line, "ubuntu") != NULL || strstr(line, "kali") != NULL) {
                strcpy(package_manager, "apt-get");
                strcpy(version_command, "apt-cache policy xz-utils | grep 'Installed:' | awk '{print $2}'");
                break;
            } else if (strstr(line, "redhat-release") != NULL || strstr(line, "centos") != NULL || strstr(line, "fedora") != NULL || strstr(line, "rhel") != NULL || strstr(line, "rocky") != NULL) {
                if (system("dnf --version >/dev/null 2>&1") == 0) {
                    strcpy(package_manager, "dnf");
                } else {
                    strcpy(package_manager, "yum");
                }
                strcpy(version_command, "yum list installed xz | grep xz | awk '{print $2}' | cut -d ':' -f 2");
                break;
            } else if (strstr(line, "opensuse") != NULL) {
                strcpy(package_manager, "zypper");
                strcpy(version_command, "zypper info xz | grep 'Version:' | awk '{print $3}'");
                break;
            }
        }
        fclose(os_release);
    } else {
        printf("Unsupported distribution.\n");
        exit(1);
    }
}

// Get xz version without executing it
void get_xz_version(char* package_manager, char* version_command, char* current_version) {
    detect_os_and_package_manager(package_manager, version_command);
    FILE* version_output = popen(version_command, "r");
    if (version_output != NULL) {
        fgets(current_version, 20, version_output);
        pclose(version_output);
    }
}

// Upgrade xz to the latest version available in the repositories
int upgrade_xz(const char* package_manager) {
    printf("Attempting to upgrade xz to the latest version using %s...\n", package_manager);
    int status = 0;
    if (strcmp(package_manager, "apt-get") == 0) {
        status = system("sudo apt-get update && sudo apt-get install -y xz-utils");
    } else if (strcmp(package_manager, "dnf") == 0 || strcmp(package_manager, "yum") == 0) {
        status = system("sudo dnf update -y xz");
    } else if (strcmp(package_manager, "zypper") == 0) {
        status = system("sudo zypper refresh && sudo zypper update -y xz");
    }
    if (status == 0) {
        printf("xz has been successfully upgraded to the latest version.\n");
        return 0;
    } else {
        printf("Failed to upgrade xz to the latest version.\n");
        return 1;
    }
}

// Install the stable version of xz if upgrade fails or if a vulnerable version is installed
void install_stable_xz() {
    printf("Downloading and installing the stable xz version from %s...\n", STABLE_VERSION_URL);
    char command[1000];
    sprintf(command, "wget -O \"xz-%s.tar.bz2\" %s", STABLE_VERSION, STABLE_VERSION_URL);
    system(command);
    sprintf(command, "tar -xjf \"xz-%s.tar.bz2\"", STABLE_VERSION);
    system(command);
    sprintf(command, "cd \"xz-%s\" && ./configure && make && sudo make install", STABLE_VERSION);
    system(command);
    printf("Successfully installed xz version %s.\n", STABLE_VERSION);
}

int main() {
    char package_manager[20];
    char version_command[100];
    char current_version[20];

    get_xz_version(package_manager, version_command, current_version);

    int vulnerable = 0;
    for (int i = 0; i < sizeof(VULNERABLE_VERSIONS) / sizeof(VULNERABLE_VERSIONS[0]); i++) {
        if (strcmp(VULNERABLE_VERSIONS[i], current_version) == 0) {
            vulnerable = 1;
            break;
        }
    }

    if (vulnerable) {
        printf("Detected vulnerable xz version: %s. Attempting to upgrade...\n", current_version);
        if (!upgrade_xz(package_manager)) {
            printf("Upgrade unsuccessful. Attempting to install a non-vulnerable version...\n");
            install_stable_xz();
        }
        printf("It is recommended to reboot your system to apply changes. Would you like to reboot now? (yes/no)\n");
        char answer[10];
        scanf("%9s", answer);
        if (strcmp(answer, "yes") == 0) {
            printf("Rebooting...\n");
            system("sudo reboot");
        } else {
            printf("Please ensure to reboot your system later.\n");
        }
    } else {
        printf("xz version is not identified as vulnerable or xz is not installed.\n");
    }

    return 0;
}
