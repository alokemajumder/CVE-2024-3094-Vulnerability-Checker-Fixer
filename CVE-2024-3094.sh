#!/bin/bash

# Define vulnerable versions and stable version details
VULNERABLE_VERSIONS=("5.6.0" "5.6.1")
STABLE_VERSION="5.4.6"
STABLE_VERSION_URL="https://excellmedia.dl.sourceforge.net/project/lzmautils/xz-5.4.6.tar.bz2"

# Check if xz is installed and its version
if command -v xz >/dev/null 2>&1; then
    XZ_VERSION=$(xz --version | head -n1 | awk '{print $NF}')
    echo "Detected xz-utils version: $XZ_VERSION"
else
    echo "xz-utils is not installed. Your system is not vulnerable to CVE-2024-3094."
    exit 0
fi

# Function to detect the operating system and its package manager
detect_os_and_package_manager() {
    if [[ -f /etc/debian_version ]] || grep -qi ubuntu /etc/os-release || grep -qi kali /etc/os-release; then
        PACKAGE_MANAGER="apt-get"
    elif [[ -f /etc/redhat-release ]] || grep -qi centos /etc/os-release || grep -qi fedora /etc/os-release || grep -qi rhel /etc/os-release || grep -qi rocky /etc/os-release; then
        PACKAGE_MANAGER=$(command -v dnf || command -v yum)
    elif grep -qi opensuse /etc/os-release; then
        PACKAGE_MANAGER="zypper"
    else
        echo "Unsupported distribution."
        exit 1
    fi
}

# Function to download and install the stable version of xz
install_stable_xz() {
    detect_os_and_package_manager
    echo "Downloading xz version $STABLE_VERSION from $STABLE_VERSION_URL..."
    wget $STABLE_VERSION_URL -O "xz-$STABLE_VERSION.tar.bz2" && \
    tar -xjf "xz-$STABLE_VERSION.tar.bz2" && \
    cd "xz-$STABLE_VERSION" && \
    ./configure && make && sudo make install

    if [[ $? -eq 0 ]]; then
        echo "xz version $STABLE_VERSION installed successfully."
        echo "It's recommended to reboot your system to apply changes. Reboot now? (y/n)"
        read answer
        if [[ "$answer" == "y" ]]; then
            echo "Rebooting now..."
            sudo reboot
        else
            echo "Please reboot your system manually later."
        fi
    else
        echo "Failed to install xz version $STABLE_VERSION. Please try manually."
        exit 1
    fi
}

# Main logic to check for vulnerable versions and act accordingly
for VULN_VERSION in "${VULNERABLE_VERSIONS[@]}"; do
    if [[ "$XZ_VERSION" == "$VULN_VERSION" ]]; then
        echo "WARNING: Your system is vulnerable to CVE-2024-3094 with xz-utils version $XZ_VERSION installed."
        install_stable_xz
        exit 0
    fi
done

echo "Your system does not appear to be vulnerable to CVE-2024-3094 based on the installed xz-utils version."
