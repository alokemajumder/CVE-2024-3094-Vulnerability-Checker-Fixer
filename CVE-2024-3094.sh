#!/bin/bash

# Vulnerable versions
declare -a VULNERABLE_VERSIONS=("5.6.0" "5.6.1")
# Stable version
STABLE_VERSION="5.4.6"
STABLE_VERSION_URL="https://github.com/tukaani/xz/releases/download/v${STABLE_VERSION}/xz-${STABLE_VERSION}.tar.gz"

# Function to download and install the stable version of xz
install_stable_xz() {
    echo "Downloading xz version $STABLE_VERSION from $STABLE_VERSION_URL..."
    wget $STABLE_VERSION_URL -O xz-${STABLE_VERSION}.tar.gz

    if [ $? -ne 0 ]; then
        echo "Failed to download. Please try to install xz-utils version $STABLE_VERSION manually."
        return 1
    fi

    echo "Extracting xz-${STABLE_VERSION}.tar.gz..."
    tar -xzf xz-${STABLE_VERSION}.tar.gz

    echo "Compiling and installing xz version $STABLE_VERSION..."
    cd xz-${STABLE_VERSION}
    ./configure && make

    if [ $? -ne 0 ]; then
        echo "Compilation failed. Please try to install xz-utils version $STABLE_VERSION manually."
        return 1
    fi

    sudo make install

    if [ $? -ne 0 ]; then
        echo "Installation failed. Please try to install xz-utils version $STABLE_VERSION manually."
        return 1
    else
        echo "xz version $STABLE_VERSION installed successfully."
    fi
}

# Detect xz-utils version and check against vulnerable versions
if command -v xz >/dev/null 2>&1; then
    XZ_VERSION=$(xz --version | head -n1 | awk '{print $NF}')
    echo "Detected xz-utils version: $XZ_VERSION"
    
    for VULN_VERSION in "${VULNERABLE_VERSIONS[@]}"; do
        if [[ "$XZ_VERSION" == "$VULN_VERSION" ]]; then
            echo "WARNING: Your system is vulnerable to CVE-2024-3094 with xz-utils version $XZ_VERSION installed."
            echo "Would you like to ensure xz is at the stable version $STABLE_VERSION? (yes/no)"
            read -r RESPONSE
            if [[ "$RESPONSE" == "yes" ]]; then
                install_stable_xz
                exit 0
            else
                echo "Manual intervention required. Please ensure your system's xz-utils is at version $STABLE_VERSION."
                exit 1
            fi
        fi
    done

    if [[ "$XZ_VERSION" != "${VULNERABLE_VERSIONS[0]}" && "$XZ_VERSION" != "${VULNERABLE_VERSIONS[1]}" ]]; then
        echo "Your system does not appear to be vulnerable to CVE-2024-3094 based on the installed xz-utils version."
    fi
else
    echo "xz-utils is not installed. Your system is not vulnerable to CVE-2024-3094."
fi
